<!DOCTYPE html>
<!--
Copyright 2015-2017 Robert Schroll

This file is part of Juno and is distributed under the terms of the
BSD license. See the file LICENSE for full details.
-->
<html>
  <head>
    <meta charset="UTF-8">
    <title>Server Settings</title>
    <style>
      body {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background-color: #333;
        color: #eee;
        font: menu;
        -webkit-user-select: none;
        cursor: default;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      h1 {
        font-size: 1.44em;
        margin-top: 0;
        text-align: center;
      }

      #command-container {
        display: flex;
      }
      #command {
        margin-left: 0.5em;
        flex-grow: 1;
      }
      #command>input {
        width: 100%;
        box-sizing: border-box;
      }
      #buttons {
        display: flex;
        margin-top: 0.5em;
        margin-bottom: 1em;
      }
      #buttons>span:not(:last-child) {
        margin-right: 0.5em;
      }
      .sep {
        flex-grow: 1; /* Push the following buttons to the right */
      }
      button {
        width: 10em;
      }
      #terminal {
        width: 81ch;  /* 80 chars + scrollbar */
        height: 27.6em;
        line-height: 1.15;
        padding: 0.25em 0.5em;
        font-family: monospace;
        font-weight: bold;
        background: #000;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        overflow-y: scroll;
        -webkit-user-select: text;
      }

      ::-webkit-scrollbar {
        width: 1ch;
      }
      ::-webkit-scrollbar-thumb {
        border-radius: 0.5ch;
        background: #555;
      }
      :hover::-webkit-scrollbar-thumb {
        background: #aaa;
      }
      ::-webkit-scrollbar-track,
      ::-webkit-scrollbar-button,
      ::-webkit-scrollbar-track-piece,
      ::-webkit-scrollbar-corner,
      ::-webkit-resizer { display: none; }
    </style>
    <script>
      'use strict';
      var ipcRenderer = require("electron").ipcRenderer;
      var jupyterCmd = null;
      var jupyterCmdDefault = null;

      document.addEventListener("DOMContentLoaded", () => {
        let $ = (s) => document.querySelector(s);
        let input = $("#command>input");
        let defaultButton = $("#default>button");
        let resetButton = $("#reset>button");
        let restartButton = $("#restart>button");
        let terminal = $("#terminal");

        function updateButtons() {
          if (input.value == jupyterCmd) {
            resetButton.disabled = true;
            restartButton.textContent = "Restart Server";
          } else {
            resetButton.disabled = false;
            restartButton.textContent = "Save and Restart";
          }
        }

        ipcRenderer.on('set-title', (event, title) => {
          $("h1").innerText = title;
        });
        ipcRenderer.on('set-cmd', (event, cmd, defaultCmd) => {
          jupyterCmd = cmd;
          jupyterCmdDefault = defaultCmd;
          input.value = cmd;
          updateButtons();
        });
        ipcRenderer.on('output-line', (event, line) => {
          let atBottom = terminal.scrollTop + terminal.offsetHeight >= terminal.scrollHeight;
          terminal.innerText += line;
          if (atBottom)
            terminal.scrollTop = terminal.scrollHeight;
        });

        defaultButton.addEventListener("click", () => {
          input.value = jupyterCmdDefault;
          updateButtons();
        });
        resetButton.addEventListener("click", () => {
          input.value = jupyterCmd;
          updateButtons();
        });
        restartButton.addEventListener("click", () => {
          ipcRenderer.send('restart', input.value);
          jupyterCmd = input.value;
          updateButtons();
          terminal.innerText = "";
        });
        input.addEventListener("input", updateButtons);
        input.addEventListener("change", updateButtons);
      });
    </script>
  </head>
  <body>
    <div class="body">
      <h1>Server Settings</h1>
      <div id="command-container">
        <span>JupyterLab command:</span>
        <span id="command">
          <input type="text"></input>
          <span id="buttons">
            <span id="default" class="sep"><button>Load Default</button></span>
            <span id="reset"><button>Reset</button></span>
            <span id="restart"><button>Restart Server</button></span>
          </span>
        </span>
      </div>
      <div id="terminal"></div>
    </div>
  </body>
</html>
